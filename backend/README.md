# Invoice-RWA Backend

Backend service for Invoice RWA (Real World Asset) platform that tokenizes physical invoices and automates lottery prize distribution.

## Core Features

### 1. User Management

- Register users (bind wallet, carrier number, select pool and donation percentage)
- Query and update user settings

### 2. Invoice Management

- Register invoices and auto-mint NFTs (ERC-1155)
- Batch invoice processing
- Query user invoices and lottery results

### 3. Relayer Service

- Gasless NFT minting for users
- Monitor relayer wallet balance

### 4. Oracle Service

- Fetch lottery results from government API
- Notify smart contracts with winning information
- Scheduled task: Process lottery results daily at 2 AM

### 5. Prize Distribution

- Listen to `LotteryResultNotified` events on-chain
- Auto-calculate and batch distribute rewards (push mode)

## Tech Stack

- Express.js - Web framework
- SQLite - Database (for ROFL TEE deployment)
- ethers.js v6 - Blockchain interaction
- Winston - Logging
- node-cron - Task scheduling

## API Endpoints

### Health Check

- `GET /health` - System health status

### User Management

- `POST /api/users/register` - Register user
- `GET /api/users/:walletAddress` - Get user info
- `PUT /api/users/:walletAddress` - Update user settings

### Pool Management

- `GET /api/pools` - Get all registered pool IDs
- `GET /api/pools/:poolId` - Get data for a specific pool
- `POST /api/pools/register` - Register a new pool (Admin only, requires signature)
- `POST /api/pools/:poolId/withdraw` - Withdraw donations from a pool (Beneficiary only, requires signature)
- `PUT /api/pools/:poolId/beneficiary` - Update a pool's beneficiary address (Admin only, requires signature)
- `PUT /api/pools/:poolId/min-donation-percent` - Update a pool's minimum donation percentage (Beneficiary only, requires signature)
- `DELETE /api/pools/:poolId` - Deactivate a pool (Admin only, requires signature)

### Invoice Management

- `POST /api/invoices/register` - Register single invoice
// ... existing code ...
- `GET /api/lottery-results?lottery_date=YYYY-MM-DD` - Query lottery results (internal API)

### Rewards API

- `GET /api/rewards/:walletAddress/:tokenTypeId` - Get claimable reward for a user and token type
- `POST /api/rewards/claim` - Claim reward for a user (User or Operator, requires signature)

### Token API

- `GET /api/tokens/:tokenTypeId` - Get data for a specific token type
- `GET /api/tokens/:tokenTypeId/drawn` - Check if a token type has been drawn

### Admin API

- `PUT /api/admin/token-uri` - Set the token URI for the InvoiceToken contract (Admin only, requires signature)
- `PUT /api/admin/pool-contract` - Set the Pool contract address (Admin only, requires signature)

## Advanced Testing: Admin & Pool Management

To test endpoints that require special permissions (like registering a pool or updating its settings), you need to generate a cryptographic signature. The following steps guide you through this process.

### Step 1: Configure Environment for Signing

Before generating signatures, ensure your `backend/.env` file contains the necessary private keys. Refer to `.env.example`.

```env
# The private key for the address that has the ADMIN_ROLE on-chain
ADMIN_PRIVATE_KEY=0x...

# The private key for the pool's beneficiary address
BENEFICIARY_PRIVATE_KEY=0x...

# The beneficiary's public address
BENEFICIARY_ADDRESS=0x...
```

### Step 2: Register a New Pool (Admin Action)

This action requires a signature from the `ADMIN_ADDRESS`.

1.  **Customize & Run the Signature Script**:
    The `createSignature.js` script reads your `.env` file to generate the correct signature and `curl` command.
    ```bash
    node createSignature.js
    ```

2.  **Execute the Output Command**:
    Copy the `curl` command generated by the script and run it in your terminal. It will look like this:
    ```bash
    curl -X POST http://localhost:3000/api/pools/register -H "Content-Type: application/json" -d '{"poolId":2,"beneficiary":"0x...","name":"My Second Charity Pool","lotteryMonth":4,"signature":"0x..."}'
    ```
    This will register a new pool on the blockchain.

### Step 3: Update Pool Donation Percentage (Beneficiary Action)

This action requires a signature from the pool's `BENEFICIARY_ADDRESS`.

1.  **Customize & Run the Signature Script**:
    Open the `createDonationSignature.js` script and configure the `poolId` and `minDonationPercent` you wish to set. Then run the script:
    ```bash
    node createDonationSignature.js
    ```

2.  **Execute the Output Command**:
    Copy and run the `curl` command generated by the script. It will look like this:
    ```bash
    curl -X PUT http://localhost:3000/api/pools/1/min-donation-percent -H "Content-Type: application/json" -d '{"minDonationPercent":30,"signature":"0x..."}'
    ```
    This will update the specified pool's settings on the blockchain.

### Step 4: Run Standard API Tests

After ensuring at least one pool is registered, you can run the standard test script:

```bash
./test-api.sh
```

## Interacting with ROFL Deployment

After deploying to ROFL, your backend is accessible via HTTPS:

### Get Your API Endpoint

```bash
# View machine information
oasis rofl machine show
```

Your API will be available at:

```
https://p3000.m<machine-id>.<region>.rofl.app
```

### API Usage

Replace `localhost:3000` with your ROFL endpoint:

```bash
# Health check
curl https://p3000.m942.opf-testnet-rofl-25.rofl.app/health

# Register user
curl -X POST https://p3000.m942.opf-testnet-rofl-25.rofl.app/api/users/register \
  -H "Content-Type: application/json" \
  -d '{"walletAddress": "0x...", "carrierNumber": "12345678", "poolId": 1, "donationPercent": 20}'

# Get invoice count
curl https://p3000.m942.opf-testnet-rofl-25.rofl.app/api/invoices/count/0x...
```

### View Logs

```bash
# Real-time logs
oasis rofl machine logs --follow
```

### Manage Secrets

```bash
# Update environment variables
oasis rofl secret set RELAYER_PRIVATE_KEY 0x...
oasis rofl secret set ORACLE_PRIVATE_KEY 0x...

# Apply changes
oasis rofl update
```

### Database Operations

```bash
# View tables
oasis rofl machine exec -- sqlite3 /rofl/storage/invoice_rwa.db ".tables"

# Check database size
oasis rofl machine exec -- ls -lh /rofl/storage/invoice_rwa.db

# Backup database
oasis rofl machine exec -- sqlite3 /rofl/storage/invoice_rwa.db .dump > backup.sql

# Restore database
cat backup.sql | oasis rofl machine exec -- sqlite3 /rofl/storage/invoice_rwa.db
```

### Monitor Machine Status

```bash
# Show machine details (endpoint, status, resources)
oasis rofl machine show

# Check when payment expires
oasis rofl machine show | grep "Paid until"
```

## Frontend Integration

Update your frontend to use the ROFL endpoint:

```javascript
// In your frontend config
const API_BASE_URL = "https://p3000.m942.opf-testnet-rofl-25.rofl.app";

// All API calls now go through ROFL
const response = await fetch(`${API_BASE_URL}/api/users/register`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    walletAddress,
    carrierNumber,
    poolId,
    donationPercent,
  }),
});
```

## Scheduled Tasks

- **Hourly**: Check relayer balance
- **Daily at 2 AM**: Process previous day's lottery results

## Documentation

- [QUICK_START.md](./QUICK_START.md) - Quick start guide for all deployment options
- [ROFL_TESTING.md](./ROFL_TESTING.md) - ROFL deployment testing guide
